<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Paxos Client {{ client.id }}</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Paxos Consensus System - Dashboard</h1>
            <h2>Client: {{ client.id }}</h2>
            <a href="/" class="back-link">‚Üê Back to Control Panel</a>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">Status:</span>
                <span id="client-status" class="status-value {% if client.running %}status-running{% else %}status-idle{% endif %}">
                    {% if client.running %}Running{% else %}Idle{% endif %}
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">Total Requests:</span>
                <span id="total-requests" class="status-value">{{ client.total_requests }}</span>
            </div>
            <div class="status-item">
                <span class="status-label">Successful:</span>
                <span id="successful-requests" class="status-value success">{{ client.successful_requests }}</span>
            </div>
            <div class="status-item">
                <span class="status-label">Failed:</span>
                <span id="failed-requests" class="status-value error">{{ client.failed_requests }}</span>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="dashboard-section">
                <h3>Request Statistics</h3>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-title">Success Rate</div>
                        <div id="success-rate" class="stat-value">
                            {% if client.total_requests > 0 %}
                                {{ (client.successful_requests / client.total_requests * 100) | round(2) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Proposals</div>
                        <div id="total-proposals" class="stat-value">{{ client.total_requests }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Committed</div>
                        <div id="committed-count" class="stat-value">
                            {% set committed = 0 %}
                            {% for req in history %}
                                {% if req.status == "committed" %}
                                    {% set committed = committed + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ committed }}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Average Response Time</div>
                        <div id="avg-response-time" class="stat-value">
                            {% set total_time = 0 %}
                            {% set count = 0 %}
                            {% for req in history %}
                                {% if req.end_time and req.start_time %}
                                    {% set total_time = total_time + (req.end_time - req.start_time) %}
                                    {% set count = count + 1 %}
                                {% endif %}
                            {% endfor %}
                            {% if count > 0 %}
                                {{ (total_time / count * 1000) | round(2) }} ms
                            {% else %}
                                0 ms
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h3>Request History</h3>
                <div class="history-controls">
                    <button id="refresh-history" class="btn btn-secondary">Refresh</button>
                    <select id="history-limit">
                        <option value="10">Last 10 requests</option>
                        <option value="20" selected>Last 20 requests</option>
                        <option value="50">Last 50 requests</option>
                        <option value="100">Last 100 requests</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Proposal ID</th>
                                <th>Status</th>
                                <th>TID</th>
                                <th>Response Time</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            {% for req in history %}
                            <tr class="history-row status-{{ req.status }}">
                                <td>{{ req.start_time | int }}</td>
                                <td>{{ req.proposal_id if req.proposal_id else 'N/A' }}</td>
                                <td class="status-cell">
                                    <span class="status-badge status-{{ req.status }}">{{ req.status }}</span>
                                </td>
                                <td>{{ req.response.tid if req.response and req.response.tid else 'N/A' }}</td>
                                <td>
                                    {% if req.end_time and req.start_time %}
                                        {{ ((req.end_time - req.start_time) * 1000) | round(2) }} ms
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-mini toggle-details" data-index="{{ loop.index0 }}">Show</button>
                                </td>
                            </tr>
                            <tr class="details-row hidden" id="details-{{ loop.index0 }}">
                                <td colspan="6">
                                    <div class="details-content">
                                        <h4>Resource Data</h4>
                                        <pre>{{ req.resource_data | tojson(indent=2) }}</pre>
                                        
                                        {% if req.response %}
                                        <h4>Response</h4>
                                        <pre>{{ req.response | tojson(indent=2) }}</pre>
                                        {% endif %}
                                        
                                        {% if req.notification %}
                                        <h4>Notification</h4>
                                        <pre>{{ req.notification | tojson(indent=2) }}</pre>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="no-data">No request history available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer>
            <p>Paxos Consensus System - Connected to Proposer: <span>{{ client.proposer_url }}</span></p>
        </footer>
    </div>

    <script src="/static/js/dashboard.js"></script>
</body>
</html>